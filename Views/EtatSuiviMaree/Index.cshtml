@model GESTION_LTIPN.Models.Stock.EtatSuiviMareeViewModel

@{
    ViewData["Title"] = "État de suivi des marées RSW";
}

<div class="row">
    <div class="col-12 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">État de suivi des marées RSW</h4>
            </div>
            <div class="card-body">
                <!-- Filters Section -->
                <form asp-action="Index" method="get">
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3">
                            <label asp-for="DateDebut" class="form-label">Première Date (Début de Traitement)</label>
                            <input asp-for="DateDebut" type="date" class="form-control" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="DateFin" class="form-label">Deuxième Date (Début de Traitement)</label>
                            <input asp-for="DateFin" type="date" class="form-control" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="Annee" class="form-label">Années</label>
                            <select asp-for="Annee" class="form-select">
                                <option value="">-- Toutes les années --</option>
                                @foreach (var annee in Model.Annees)
                                {
                                    <option value="@annee">@annee</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="BateauFilter" class="form-label">Filtrer par Bateau</label>
                            <select asp-for="BateauFilter" class="form-select">
                                <option value="">-- Tous les Bateaux --</option>
                                @foreach (var bateau in Model.Bateaux)
                                {
                                    <option value="@bateau">@bateau</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3 mb-3">
                            <label asp-for="EspeceFilter" class="form-label">Filtrer par Espèce</label>
                            <select asp-for="EspeceFilter" class="form-select">
                                <option value="">-- Toutes les espèces --</option>
                                @foreach (var espece in Model.Especes)
                                {
                                    <option value="@espece">@espece</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="NumeroBon" class="form-label">Numéro de Bon</label>
                            <input asp-for="NumeroBon" type="text" class="form-control" placeholder="Rechercher par numéro de bon..." />
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="ri-filter-line me-1"></i> Filtrer
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="ri-refresh-line me-1"></i> Réinitialiser
                            </a>
                        </div>
                    </div>

                    @if (Model.DateDebut.HasValue || Model.DateFin.HasValue || !string.IsNullOrEmpty(Model.Annee) ||
                         !string.IsNullOrEmpty(Model.BateauFilter) || !string.IsNullOrEmpty(Model.EspeceFilter) || !string.IsNullOrEmpty(Model.NumeroBon))
                    {
                        <div class="row mb-3">
                            <div class="col-md-4 mb-3">
                                <label asp-for="MatriculeCamionFilter" class="form-label">
                                    <i class="ri-truck-line me-1"></i> Matricule Camion
                                </label>
                                <select asp-for="MatriculeCamionFilter" class="form-select">
                                    <option value="">-- Tous les Matricules --</option>
                                    @foreach (var matricule in Model.MatriculesCamion)
                                    {
                                        <option value="@matricule">@matricule</option>
                                    }
                                </select>
                            </div>
                        </div>
                    }
                </form>

                @if (!string.IsNullOrEmpty(Model.FilteredTitle))
                {
                    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                        <i class="ri-information-line me-2"></i>
                        <strong>@Model.FilteredTitle</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (Model.Marees.Any())
                {
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-primary">
                                <i class="ri-file-list-line me-1"></i>
                                @Model.Marees.Count() résultat(s)
                            </span>
                        </div>
                        <a asp-action="ExportExcel" asp-all-route-data="@(new Dictionary<string, string>
                            {
                                { "dateDebut", Model.DateDebut?.ToString("yyyy-MM-dd") ?? "" },
                                { "dateFin", Model.DateFin?.ToString("yyyy-MM-dd") ?? "" },
                                { "annee", Model.Annee ?? "" },
                                { "bateauFilter", Model.BateauFilter ?? "" },
                                { "especeFilter", Model.EspeceFilter ?? "" },
                                { "numeroBon", Model.NumeroBon?.ToString() ?? "" },
                                { "matriculeCamionFilter", Model.MatriculeCamionFilter ?? "" }
                            })" class="btn btn-success">
                            <i class="ri-file-excel-2-line me-1"></i> Export Excel
                        </a>
                    </div>

                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover table-bordered align-middle mb-0">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Numéro Bon</th>
                                    <th>Matricule Camion</th>
                                    <th>Numéro Citerne</th>
                                    <th class="text-end">Poids</th>
                                    <th class="text-end">Temp. Port</th>
                                    <th class="text-end">Temp. Citerne</th>
                                    <th>Bateau</th>
                                    <th>Marée</th>
                                    <th>Cuve</th>
                                    <th>Espèce</th>
                                    <th>Observation</th>
                                    <th>Date Sortie Port</th>
                                    <th>Heure Sortie Port</th>
                                    <th>Date Arrivée</th>
                                    <th>Heure Arrivée</th>
                                    <th>Resp. Arrivage</th>
                                    <th>Date Début Décharge</th>
                                    <th>Heure Début Décharge</th>
                                    <th>Resp. Début Décharge</th>
                                    <th>Salle</th>
                                    <th>Bassin</th>
                                    <th>Date Fin Décharge</th>
                                    <th>Heure Fin Décharge</th>
                                    <th>Resp. Fin Décharge</th>
                                    <th>Date Début Traitement</th>
                                    <th>Heure Début Traitement</th>
                                    <th>Resp. Début Traitement</th>
                                    <th>Date Début Traitement / Prod</th>
                                    <th>Date Fin Traitement</th>
                                    <th>Heure Fin Traitement</th>
                                    <th>Resp. Fin Traitement</th>
                                    <th class="text-end">Temps Attente Citerne</th>
                                    <th class="text-end">Temps Attente Bassin</th>
                                    <th class="text-end">Temps Attente Traitement</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Marees)
                                {
                                    <tr>
                                        <td class="text-center"><strong class="text-primary">@item.ID</strong></td>
                                        <td><span class="badge bg-info">@item.NumeroBon</span></td>
                                        <td>@item.MatriculeCamion</td>
                                        <td>@item.NumeroCiterne</td>
                                        <td class="text-end">@item.Poids</td>
                                        <td class="text-end">@item.TemperaturePort</td>
                                        <td class="text-end">@item.TemperatureCiterne</td>
                                        <td>@item.Bateau</td>
                                        <td>@item.Maree</td>
                                        <td>@item.Cuve</td>
                                        <td>@item.Espece</td>
                                        <td><small class="text-muted">@item.Observation</small></td>
                                        <td>@item.DateSortiePort</td>
                                        <td>@item.HeureSortiePort</td>
                                        <td>@item.DateArrivee</td>
                                        <td>@item.HeureArrivee</td>
                                        <td>@item.ResponsableArrivage</td>
                                        <td>@item.DateDebutDecharge</td>
                                        <td>@item.HeureDebutDecharge</td>
                                        <td>@item.ResponsableDebutDecharge</td>
                                        <td>@item.Salle</td>
                                        <td>@item.Bassin</td>
                                        <td>@item.DateFinDecharge</td>
                                        <td>@item.HeureFinDecharge</td>
                                        <td>@item.ResponsableFinDecharge</td>
                                        <td>@item.DateDebutTraitement</td>
                                        <td>@item.HeureDebutTraitement</td>
                                        <td>@item.ResponsableDebutTraitement</td>
                                        <td>@item.DateDebutTraitementProd</td>
                                        <td>@item.DateFinTraitement</td>
                                        <td>@item.HeureFinTraitement</td>
                                        <td>@item.ResponsableFinTraitement</td>
                                        <td class="text-end">@item.TempsAttenteCiterne</td>
                                        <td class="text-end">@item.TempsAttenteBassin</td>
                                        <td class="text-end">@item.TempsAttenteTraitement</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else if (Model.DateDebut.HasValue || Model.DateFin.HasValue || !string.IsNullOrEmpty(Model.Annee) ||
                         !string.IsNullOrEmpty(Model.BateauFilter) || !string.IsNullOrEmpty(Model.EspeceFilter) || !string.IsNullOrEmpty(Model.NumeroBon))
                {
                    <div class="alert alert-info text-center py-5" role="alert">
                        <i class="ri-information-line fs-1 d-block mb-2"></i>
                        <p class="mb-0">Aucune donnée trouvée pour les filtres sélectionnés.</p>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="ri-ship-line fs-1 text-muted d-block mb-2"></i>
                        <p class="text-muted mb-0">Utilisez les filtres ci-dessus pour rechercher des marées</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
